@model IoT_Web.Models.Maquines.LiniaGeneralModel

<link rel="stylesheet" href="~/Content/Overlay.css" />
<link rel="stylesheet" href="~/Content/DataTableCustom.css" />
<link rel="stylesheet" href="~/Content/FonsGrafiques.css" />

<style>
    .modal-dialog-centered {
        max-width: 80% !important;
    }
</style>

<div class="container backgroundGraphics" id="containterImatge">
    <a class="fa fa-minus-circle collapsed" data-toggle="collapse" data-parent="#collapseImatge" href="#collapseImatge" aria-expanded="false" aria-controls="collapseImatge">
    </a>
    <p style="font-size:20px;">Layout</p>

    <div id="collapseImatge" class="collapse show">
        <div class="row">
            <div class="col" style="padding-bottom:10px">
                <img src="~/Images/DanishCrown_Linies.png" class="img-fluid">

                <!-- Botons Strapex -->

                <button class="btn" style="position: absolute; top: 23%; left: 59%; transform: translate(-50%, -50%); -ms-transform: translate(-50%, -50%); background-color: #D6E30F; color: white; font-size: 16px; height: 4%; cursor: pointer; border-radius: 20px; height: 20px; " id="button" data-toggle="modal" data-target="#GraficaLinealCadenciaAllStrapexModal">
                    All Strapex
                </button>

                <button class="btn" style="position: absolute; top: 31%; left: 59%; transform: translate(-50%, -50%); -ms-transform: translate(-50%, -50%); background-color: #D6E30F; color: white; font-size: 16px; height: 4%; cursor: pointer; border-radius: 20px; height: 20px; " id="button" data-toggle="modal" data-target="#GraficaLinealCadenciaStrapexModal" data-val="0">
                    SL01
                </button>

                <button class="btn" style="position: absolute; top: 44%; left: 59%; transform: translate(-50%, -50%); -ms-transform: translate(-50%, -50%); background-color: #D6E30F; color: white; font-size: 16px; height: 4%; cursor: pointer; border-radius: 20px; height: 20px; " id="button" data-toggle="modal" data-target="#GraficaLinealCadenciaStrapexModal" data-val="1">
                    SL02
                </button>

                <button class="btn" style="position: absolute; top: 58%; left: 59%; transform: translate(-50%, -50%); -ms-transform: translate(-50%, -50%); background-color: #D6E30F; color: white; font-size: 16px; height: 4%; cursor: pointer; border-radius: 20px; height: 20px; " id="button" data-toggle="modal" data-target="#GraficaLinealCadenciaStrapexModal" data-val="2">
                    SL03
                </button>

                <button class="btn" style="position: absolute; top: 70%; left: 59%; transform: translate(-50%, -50%); -ms-transform: translate(-50%, -50%); background-color: #D6E30F; color: white; font-size: 16px; height: 4%; cursor: pointer; border-radius: 20px; height: 20px; " id="button" data-toggle="modal" data-target="#GraficaLinealCadenciaStrapexModal" data-val="3">
                    SL04
                </button>

                <button class="btn" style="position: absolute; top: 84%; left: 59%; transform: translate(-50%, -50%); -ms-transform: translate(-50%, -50%); background-color: #D6E30F; color: white; font-size: 16px; height: 4%; cursor: pointer; border-radius: 20px; height: 20px; " id="button" data-toggle="modal" data-target="#GraficaLinealCadenciaStrapexModal" data-val="4">
                    SL05
                </button>

                <button class="btn" style="position: absolute; top: 93%; left: 59%; transform: translate(-50%, -50%); -ms-transform: translate(-50%, -50%); background-color: #D6E30F; color: white; font-size: 16px; height: 4%; cursor: pointer; border-radius: 20px; height: 20px; " id="button" data-toggle="modal" data-target="#GraficaLinealCadenciaStrapexModal" data-val="5">
                    SL06
                </button>

                <!-- Fi Botons Strapex -->
                <!-- Botons Escaners -->
                <button class="btn" style="position: absolute; top: 15%; left: 66%; transform: translate(-50%, -50%); -ms-transform: translate(-50%, -50%); background-color: #9FE2BF; color: white; font-size: 16px; height: 4%; cursor: pointer; border-radius: 20px; height: 20px;" id="button" data-toggle="modal" data-target="#InfoEscanersModal" data-val="IOB01.SCA01">
                    IOB01.SCA01
                </button>

                <button class="btn" style="position: absolute; top: 28%; left: 68%; transform: translate(-50%, -50%); -ms-transform: translate(-50%, -50%); background-color: #9FE2BF; color: white; font-size: 16px; height: 4%; cursor: pointer; border-radius: 20px; height: 20px;" id="button" data-toggle="modal" data-target="#InfoEscanersModal" data-val="IOB01.SCA02">
                    IOB01.SCA02
                </button>

                @*<button class="btn" style="position: absolute;top: 22%;left: 35%;transform: translate(-50%, -50%);-ms-transform: translate(-50%, -50%);
        background-color: #555;color: white;font-size: 16px;height:4%;cursor: pointer;border-radius: 20px;height:20px;" id="button" data-toggle="modal" data-target="#InfoEscanersModal" data-val="IOB02.SCA02">
                    IOB02.SCA02
                </button>

                <button class="btn" style="position: absolute;top: 28%;left: 45%;transform: translate(-50%, -50%);-ms-transform: translate(-50%, -50%);
        background-color: #555;color: white;font-size: 16px;height:4%;cursor: pointer;border-radius: 20px;height:20px;" id="button" data-toggle="modal" data-target="#InfoEscanersModal" data-val="IOB02.SCA01">
                    IOB02.SCA01
                </button>

                <button class="btn" style="position: absolute;top: 22%;left: 55%;transform: translate(-50%, -50%);-ms-transform: translate(-50%, -50%);
        background-color: #555;color: white;font-size: 16px;height:4%;cursor: pointer;border-radius: 20px;height:20px;" id="button" data-toggle="modal" data-target="#InfoEscanersModal" data-val="IOB02.SCA03">
                    IOB02.SCA03
                </button>*@

                <button class="btn" style="position: absolute; top: 55%; left: 23%; transform: translate(-50%, -50%); -ms-transform: translate(-50%, -50%); background-color: #DE3163; color: white; font-size: 16px; height: 4%; cursor: pointer; border-radius: 20px; height: 20px;" id="button" data-toggle="modal" data-target="#InfoEscanersModal" data-val="IOB03.SCA04">
                    IOB03.SCA04
                </button>

                <button class="btn" style="position: absolute; top: 50%; left: 26%; transform: translate(-50%, -50%); -ms-transform: translate(-50%, -50%); background-color: #DE3163; color: white; font-size: 16px; height: 4%; cursor: pointer; border-radius: 20px; height: 20px;" id="button" data-toggle="modal" data-target="#InfoEscanersModal" data-val="IOB03.SCA05">
                    IOB03.SCA05
                </button>

                <button class="btn" style="position: absolute; top: 38%; left: 24%; transform: translate(-50%, -50%); -ms-transform: translate(-50%, -50%); background-color: #DE3163; color: white; font-size: 16px; height: 4%; cursor: pointer; border-radius: 20px; height: 20px;" id="button" data-toggle="modal" data-target="#InfoEscanersModal" data-val="IOB03.SCA06">
                    IOB03.SCA06
                </button>

                <button class="btn" style="position: absolute; top: 52%; left: 95%; transform: translate(-50%, -50%); -ms-transform: translate(-50%, -50%); background-color: #FFBF00; color: white; font-size: 16px; height: 4%; cursor: pointer; border-radius: 20px; height: 20px; " id="button" data-toggle="modal" data-target="#InfoEscanersModal" data-val="IOB04.SCA01">
                    IOB04.SCA01
                </button>

                <button class="btn" style="position: absolute; top: 64%; left: 77%; transform: translate(-50%, -50%); -ms-transform: translate(-50%, -50%); background-color: #FFBF00; color: white; font-size: 16px; height: 4%; cursor: pointer; border-radius: 20px; height: 20px; " id="button" data-toggle="modal" data-target="#InfoEscanersModal" data-val="IOB04.SCA02">
                    IOB04.SCA02
                </button>

                <button class="btn" style="position: absolute; top: 76%; left: 95%; transform: translate(-50%, -50%); -ms-transform: translate(-50%, -50%); background-color: #FFBF00; color: white; font-size: 16px; height: 4%; cursor: pointer; border-radius: 20px; height: 20px; " id="button" data-toggle="modal" data-target="#InfoEscanersModal" data-val="IOB04.SCA03">
                    IOB04.SCA03
                </button>





                <button class="btn" style="position: absolute; top: 50%; left: 11%; transform: translate(-50%, -50%); -ms-transform: translate(-50%, -50%); background-color: #6495ED; color: white; font-size: 16px; height: 4%; cursor: pointer; border-radius: 20px; height: 20px; rotate: -90deg;" id="button" data-toggle="modal" data-target="#InfoEscanersModal" data-val="IOB05.SCA04">
                    IOB05.SCA04
                </button>

                <button class="btn" style="position: absolute; top: 54%; left: 5%; transform: translate(-50%, -50%); -ms-transform: translate(-50%, -50%); background-color: #6495ED; color: white; font-size: 16px; height: 4%; cursor: pointer; border-radius: 20px; height: 20px;" id="button" data-toggle="modal" data-target="#InfoEscanersModal" data-val="IOB05.SCA05">
                    IOB05.SCA05
                </button>

                <button class="btn" style="position: absolute; top: 75%; left: 19%; transform: translate(-50%, -50%); -ms-transform: translate(-50%, -50%); background-color: #6495ED; color: white; font-size: 16px; height: 4%; cursor: pointer; border-radius: 20px; height: 20px;" id="button" data-toggle="modal" data-target="#InfoEscanersModal" data-val="IOB06.SCA04">
                    IOB06.SCA04
                </button>

                <button class="btn" style="position: absolute; top: 75%; left: 5%; transform: translate(-50%, -50%); -ms-transform: translate(-50%, -50%); background-color: #6495ED; color: white; font-size: 16px; height: 4%; cursor: pointer; border-radius: 20px; height: 20px;" id="button" data-toggle="modal" data-target="#InfoEscanersModal" data-val="IOB06.SCA05">
                    IOB06.SCA05
                </button>
                <!-- Fi Botons Escaners -->
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="GraficaLinealCadenciaStrapexModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="lineChartTitle"></h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="container mb-2">
                        <div class="col-12" id="conjunt-cadencies">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="GraficaLinealCadenciaAllStrapexModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="lineChartTitleAllStrapex"></h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="container mb-2">
                        <div class="col-12" id="conjunt-cadencies-all-strapex">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade static lazy" id="InfoEscanersModal" tabindex="-1" role="dialog" aria-labelledby="ScanerModal" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="donutchartTitleModal"></h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="modal-body">
                        <div class="container mb-2">
                            <div class="col-12" id="conjunt-piechart">
                            </div>
                        </div>
                    </div>

                    <table class="table" style="border-radius:10px;">

                        <thead style="background:linear-gradient(205deg, #B8C9CD, #D5E2E4);">
                            <tr>
                                <th scope="col">@Recursos.Idioma.Descripcio</th>
                                <th scope="col">%</th>
                            </tr>
                        </thead>
                        <tbody style="background:white;" id="tbodyPiechart">

                        </tbody>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container backgroundGraphics" id="containerCadenciesInfeed">
    <a class="fa fa-minus-circle collapsed" data-toggle="collapse" data-parent="#collapseCadencies" href="#collapseCadencies" aria-expanded="false" aria-controls="collapseCadencies">
    </a>
    <p style="font-size:20px;">@Recursos.Idioma.Total @Recursos.Idioma.Cadencia</p>
    <div id="collapseCadencies" class="collapse show">
        <div class="container mb-2">
            <div class="col-12" id="conjunt-cadencies-infeed">
            </div>

            <script>

                var dadesPlot = [];

                var dadesChart = @Html.Raw(Json.Encode(Model.LiniaGeneral.ChartCadencies.Charts2Infeed));
                if (dadesChart != null) {
                    dadesChart.forEach(chart => {

                        let xAxisDate = chart.XAxis.map(x => {
                            let momentObj = moment(x, 'DD/MM/YYYY HH:mm:ss');
                            return momentObj.toDate();
                        });

                        let tracePlot = {
                            x: xAxisDate,
                            y: chart.YAxis,
                            type: 'bar',
                            text: chart.YAxis.map(String),
                            textposition: 'auto',
                            name: chart.Titol,
                            hovertemplate: "" +
                                "<b>@Recursos.Idioma.CaixesTotals:</b> %{y:}<br>" +
                                "<extra></extra>"
                        }

                        dadesPlot.push(tracePlot);

                    });

                    var layoutPlot = {
                        showlegend: true,
                        barmode: 'stack',
                        height: 600,
                        width: 1080,
                        autosize: false,
                        plot_bgcolor: "#353c48",
                        paper_bgcolor: "#353c48",
                        xaxis: {
                            title: null,
                            showline: true,
                            showgrid: true,
                            gridcolor: 'grey'
                        },
                        yaxis: {
                            title: null,
                            showline: true,
                            showgrid: true,
                            gridcolor: 'grey'
                        },
                        font: {
                            color: '#ffffff'
                        }
                    };

                    var configPlot = {
                        responsive: true
                    }

                    Plotly.newPlot('conjunt-cadencies-infeed', dadesPlot, layoutPlot, configPlot);
                }

                function descarregarDades() {
                    var csv = "Date;YAxis;Source\n";
                    dadesPlot.forEach(function (trace) {
                        var x = trace.x;
                        var y = trace.y;
                        var source = trace.name;
                        var data = [];
                        for (var i = 0; i < x.length; i++) {
                            data.push({ date: moment(x[i]).format("DD/MM/YYYY HH:mm:ss"), value: y[i] });
                        }
                        data.sort(function (a, b) {
                            return new Date(a.date) - new Date(b.date);
                        });
                        var total = 0;
                        for (var i = 0; i < data.length; i++) {
                            csv += data[i].date + ";" + data[i].value + ";" + source + "\n";
                            total += data[i].value;
                        }
                        csv += "Total;" + total + ";\n";
                    });

                    // Crear enlace para descargar archivo CSV
                    var encodedUri = encodeURI(csv);
                    var link = document.createElement("a");
                    link.setAttribute("href", "data:text/csv;charset=utf-8," + encodedUri);
                    link.setAttribute("download", "TotalCadence.csv");
                    document.body.appendChild(link); // Required for FF

                    // Hacer clic en el enlace para descargar el archivo
                    link.click();
                }

            </script>
        </div>
    </div>
    <div class="row">
        <button class="btn" style="background-color: #009000; color: white; display: block; margin: 10px auto;" id="descarregar" onclick="descarregarDades()">@Recursos.Idioma.DescarregarCSV</button>
    </div>
</div>

<div class="container backgroundGraphics" id="containterDadesGenerals">
    <a class="fa fa-minus-circle collapsed" data-toggle="collapse" data-parent="#collapseDadesGenerals" href="#collapseDadesGenerals" aria-expanded="false" aria-controls="collapseDadesGenerals">
    </a>
    <div id="collapseDadesGenerals" class="collapse show">
        <div class="row">
            <div class="col">
                <table class="table" style="border-radius:10px;">
                    <thead style="background:linear-gradient(205deg, #B8C9CD, #D5E2E4);">
                        <tr>
                            <th colspan="4" style="text-align: center;">@Recursos.Idioma.EstadistiquesGenerals</th>
                        </tr>
                    </thead>
                    <tbody style="background:white;">
                        <tr>
                            <td>@Recursos.Idioma.CadenciaMitja:</td>
                            <td>@Model.LiniaGeneral.DadesGlobalsLinia.CadenciaMitja @Recursos.Idioma.Caixa / @Recursos.Idioma.Hora</td>
                            <td>@Recursos.Idioma.CaixesTotals:</td>
                            <td>
                                @Model.LiniaGeneral.DadesGlobalsLinia.CaixesTotals
                            </td>
                        </tr>
                        <tr>
                            <td>@Recursos.Idioma.Rebutjats</td>
                            <td>@Model.LiniaGeneral.DadesGlobalsLinia.RebuigTotals</td>
                            <td>Max @Recursos.Idioma.Cadencia</td>
                            <td>@Model.LiniaGeneral.DadesGlobalsLinia.CadenciaMaxima @Recursos.Idioma.Caixa / @Recursos.Idioma.Hora</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="row">
            <div class="col">
                <table class="table" style="border-radius:10px;">
                    <thead style="background:linear-gradient(205deg, #B8C9CD, #D5E2E4);">
                        <tr>
                            <th colspan="4" style="text-align: center;">Waiting for boxes</th>
                        </tr>
                    </thead>
                    <tbody style="background:white;">
                        @foreach (var linia in Model.LiniaGeneral.TempsLinesSenseCaixes)
                        {
                            <tr>
                                <td>@linia.NomLinia_1:</td>
                                <td>@(linia.TempsParades_1.Days * 24 + linia.TempsParades_1.Hours)h @linia.TempsParades_1.Minutes.ToString()min @linia.TempsParades_1.Seconds.ToString()s</td>
                                <td>@linia.NomLinia_2:</td>
                                <td>@(linia.TempsParades_2.Days * 24 + linia.TempsParades_2.Hours)h @linia.TempsParades_2.Minutes.ToString()min @linia.TempsParades_2.Seconds.ToString()s</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <div class="row">
            <div class="col">
                <table class="table" style="border-radius:10px;">
                    <thead style="background:linear-gradient(205deg, #B8C9CD, #D5E2E4);">
                        <tr>
                            <th colspan="4" style="text-align: center;">Stock signal</th>
                        </tr>
                    </thead>
                    <tbody style="background:white;">
                        @foreach (var linia in Model.LiniaGeneral.TempsLinesParadesTavil)
                        {
                            <tr>
                                <td>@linia.NomLinia_1:</td>
                                <td>@(linia.TempsParades_1.Days * 24 + linia.TempsParades_1.Hours)h @linia.TempsParades_1.Minutes.ToString()min @linia.TempsParades_1.Seconds.ToString()s</td>
                                <td>@linia.NomLinia_2:</td>
                                <td>@(linia.TempsParades_2.Days * 24 + linia.TempsParades_2.Hours)h @linia.TempsParades_2.Minutes.ToString()min @linia.TempsParades_2.Seconds.ToString()s</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <div class="row">
            <div class="col">
                <table class="table" style="border-radius:10px;">
                    <thead style="background:linear-gradient(205deg, #B8C9CD, #D5E2E4);">
                        <tr>
                            <th colspan="4" style="text-align: center;">Total boxes per lines</th>
                        </tr>
                    </thead>
                    <tbody style="background:white;">
                        @foreach (var linia in Model.LiniaGeneral.LlistaCaixesTotals)
                        {
                            <tr>
                                <td>@linia.NomLinia_1:</td>
                                <td>@(linia.CaixesTotals_1)</td>
                                <td>@linia.NomLinia_2:</td>
                                <td>@(linia.CaixesTotals_2)</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

        <div class="row">
            <div class="col">
                <table class="table" style="border-radius:10px;">
                    <thead style="background:linear-gradient(205deg, #B8C9CD, #D5E2E4);">
                        <tr>
                            <th colspan="4" style="text-align: center;">Errors downtime</th>
                        </tr>
                    </thead>
                    <tbody style="background:white;">
                        <tr>
                            <td>Labeller_App_Error:</td>
                            <td>@(Model.LiniaGeneral.EstatsParades.Labeller_App_Error.Days * 24 + Model.LiniaGeneral.EstatsParades.Labeller_App_Error.Hours)h @Model.LiniaGeneral.EstatsParades.Labeller_App_Error.Minutes.ToString()min @Model.LiniaGeneral.EstatsParades.Labeller_App_Error.Seconds.ToString()s</td>
                            <td>Transport_Error:</td>
                            <td>
                                @(Model.LiniaGeneral.EstatsParades.Transport_Error.Days * 24 + Model.LiniaGeneral.EstatsParades.Transport_Error.Hours)h @Model.LiniaGeneral.EstatsParades.Transport_Error.Minutes.ToString()min @Model.LiniaGeneral.EstatsParades.Transport_Error.Seconds.ToString()s
                            </td>
                        </tr>
                        <tr>
                            <td>Strappex_Error</td>
                            <td>@(Model.LiniaGeneral.EstatsParades.Strappex_Error.Days * 24 + Model.LiniaGeneral.EstatsParades.Strappex_Error.Hours)h @Model.LiniaGeneral.EstatsParades.Strappex_Error.Minutes.ToString()min @Model.LiniaGeneral.EstatsParades.Strappex_Error.Seconds.ToString()s</td>
                            <td>PopUpPDB_active</td>
                            <td>@(Model.LiniaGeneral.EstatsParades.PopUpPDB_active.Days * 24 + Model.LiniaGeneral.EstatsParades.PopUpPDB_active.Hours)h @Model.LiniaGeneral.EstatsParades.PopUpPDB_active.Minutes.ToString()min @Model.LiniaGeneral.EstatsParades.PopUpPDB_active.Seconds.ToString()s</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@*<div class="container backgroundGraphics" id="containerProducte">
    <a class="fa fa-minus-circle collapsed" data-toggle="collapse" data-parent="#collapseProducte" href="#collapseProducte" aria-expanded="false" aria-controls="collapseProducte">
    </a>
    <p style="font-size:20px;">@Recursos.Idioma.ProductesTotals</p>
    <div id="collapseProducte" class="collapse show">
        <div class="container mb-2">
            <div class="row">
                <div class="col-12" id="conjunt-productes">
                </div>

                <script>

                    var dadesPlot2 = [];

                    var dadesChart2 = @Html.Raw(Json.Encode(Model.LiniaGeneral.ChartsProductes.Charts2));
                    dadesChart2.forEach(chart => {

                        let xAxisDate = chart.XAxis.map(x => {
                            let momentObj = moment(x, 'DD/MM/YYYY HH:mm:ss');
                            return momentObj.toDate();
                        });

                        let tracePlot = {
                            x: xAxisDate,
                            y: chart.YAxis,
                            mode: 'lines+markers',
                            name: chart.Titol,
                            hovertemplate: "" +
                                "<b>@Recursos.Idioma.Hora:</b> %{x|%H:%M:%S}<br>" +
                                "<b>@Recursos.Idioma.ProductesTotals:</b> %{y:}<br>" +
                                "<extra></extra>"
                        }

                        dadesPlot2.push(tracePlot);

                    });

                    var layoutPlot2 = {
                        showlegend: true,
                        height: 600,
                        width: 1080,
                        autosize: false,
                        hovermode: "x",
                        plot_bgcolor: "#353c48",
                        paper_bgcolor: "#353c48",
                        xaxis: {
                            title: null,
                            showline: true,
                            showgrid: true,
                            gridcolor: 'grey'
                        },
                        yaxis: {
                            title: null,
                            showline: true,
                            showgrid: true,
                            gridcolor: 'grey'
                        },
                        font: {
                            color: '#ffffff'
                        }
                    };

                    var configPlot2 = { responsive: true }

                    Plotly.newPlot('conjunt-productes', dadesPlot2, layoutPlot2, configPlot2);

                </script>
            </div>
        </div>
    </div>
</div>*@

<div class="container backgroundGraphics" id="containerPercentatgeCaixesTotals">
    <a class="fa fa-minus-circle collapsed" data-toggle="collapse" data-parent="#collapseWarningFrequents" href="#collapseWarningFrequents" aria-expanded="false" aria-controls="collapseWarningFrequents">
    </a>
    <p style="font-size:20px;">@Recursos.Idioma.CaixesTotals @Recursos.Idioma.Percentatge</p>
    <div id="collapseWarningFrequents" class="collapse show">
        <div class="row graficaWarning" id="divPercentatgeWarning" style="padding-bottom: 35px; padding-top: 20px;margin-top:20px;">
            <div class="col" id="DonutWarningPercentatgeCaixes" style="min-width: 300px;min-height: 300px;">
            </div>
            <div class="col" id="TableWarningPercentatgecAIXES" style="min-width: 300px; margin-right:2%">

                <div class="col" style="border-radius:10px;">
                    <table class="table" style="border-radius:10px;">

                        <thead style="background:linear-gradient(205deg, #B8C9CD, #D5E2E4);">
                            <tr>
                                <th scope="col"></th>
                                <th scope="col">@Recursos.Idioma.Descripcio</th>
                                <th scope="col">%</th>
                            </tr>
                        </thead>
                        <tbody style="background:white;">
                            @foreach (var alarma in Model.LiniaGeneral.PercentatgesNoReads)
                            {
                                <tr>

                                    <td style="display:inline-block; width: 15px; margin-top: 10px; margin-bottom: 10px; border: 1px solid black; margin-left: 10px; border-radius: 10px;" bgcolor="@alarma.Color"></td>
                                    <td>@alarma.Nom</td>
                                    <td style="width:15%">@alarma.Percentatge % (@alarma.QuantitatCaixes)</td>
                                </tr>

                            }
                            @if (Model.LiniaGeneral.PercentatgesNoReads.Count() > 0)
                            {
                                <tr style="background-color:darkgray">
                                    <td></td>
                                    <td>@Recursos.Idioma.Total</td>
                                    <td style="width:15%">@Model.LiniaGeneral.PercentatgesNoReads.Sum(X => X.QuantitatCaixes)</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container backgroundGraphics" id="containerAlarmesFrequents">
    <a class="fa fa-minus-circle collapsed" data-toggle="collapse" data-parent="#collapseAlarmesFrequents" href="#collapseAlarmesFrequents" aria-expanded="false" aria-controls="collapseAlarmesFrequents">
    </a>
    <p style="font-size:20px;">@Recursos.Idioma.Alarmes @Recursos.Idioma.Percentatge</p>
    <div id="collapseAlarmesFrequents" class="collapse show">
        <div class="row graficaAlarmes" id="divPercentatgeAlarmes" style="padding-bottom: 35px; padding-top: 20px;margin-top:20px;">
            <div class="col" id="DonutAlarmes" style="min-width: 300px;min-height: 300px;">
            </div>
            <div class="col" id="TableAlarmesPercentatge" style="min-width: 300px; margin-right:2%">
                <div class="col" style="border-radius:10px;">
                    <table class="table" style="border-radius:10px;">

                        <thead style="background:linear-gradient(205deg, #B8C9CD, #D5E2E4);">
                            <tr>
                                <th scope="col"></th>
                                <th scope="col">@Recursos.Idioma.Descripcio</th>
                                <th scope="col">%</th>
                            </tr>
                        </thead>
                        <tbody style="background:white;">
                            @foreach (var alarma in Model.LiniaGeneral.PercentatgesAlarmes)
                            {
                                <tr>

                                    <td style="display:inline-block; width: 15px; margin-top: 10px; margin-bottom: 10px; border: 1px solid black; margin-left: 10px; border-radius: 10px;" bgcolor="@alarma.Color"></td>
                                    <td>@alarma.Nom</td>
                                    <td style="width:15%">@alarma.Percentatge % (@alarma.QuantitatCaixes)</td>
                                </tr>

                            }
                            @if (Model.LiniaGeneral.PercentatgesAlarmes.Count() > 0)
                            {
                                <tr style="background-color:darkgray">
                                    <td></td>
                                    <td>@Recursos.Idioma.Total</td>
                                    <td style="width:15%">@Model.LiniaGeneral.PercentatgesAlarmes.Sum(X => X.QuantitatCaixes)</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

</div>

<div class="container backgroundGraphics" id="containerAlarmes">
    <a class="fa fa-minus-circle collapsed" data-toggle="collapse" data-parent="#collapseAlarmes" href="#collapseAlarmes" aria-expanded="false" aria-controls="collapseAlarmes">
    </a>
    <p style="font-size:20px;">@Recursos.Idioma.Alarmes</p>
    <div id="collapseAlarmes" class="collapse show">
        <div class="row">
            <div class="col" id="chartContainer2" style="min-height: 170px; max-height:170px;">
            </div>
        </div>
        <div style="text-align: center;" id="AlarmesCheckbox">
        </div>
    </div>

</div>

<div id="noData" style="display: none; margin-top:200px;margin-bottom:200px;">
    <p align="center">@Recursos.Idioma.NoDades</p>
</div>

<script type="text/javascript" src="~/Scripts/JS_Formadora.js"></script>
<script type="text/javascript" src="~/PDF/GestorPDF.js"></script>
<script type="text/javascript" src="~/PDF/jquery.color-animation.js"></script>

<script>
    var machine = "@Model.LiniaGeneral.Nom";
    var idMaquina = @Model.LiniaGeneral.IdMaquina;

    $(document).ready(function () {

        SeleccionarMenu(machine, idMaquina);//Selecciona la màquina activa

        //Actualitzem la durada
        refreshDuration();
    });

    var interval;
    var minuteNumber = 0;
    //reset visibilitat divs
    $('#noData').hide();
    $('#TableAlarms').show();
    $('#atras').hide();
    $('#TableVariables').hide();
    $('#containerDades').hide();
    $('#containerPercentatgeEstats').show();

    $('#divPDF').hide();

    var estatsInfeed = CrearDates(@Html.Raw(Model.LiniaGeneral.LlistaAlimentacio.FirstOrDefault().EstatsJson));
    var estatsInfeed2;

    if (@Model.LiniaGeneral.LlistaAlimentacio.Count > 2)
        estatsInfeed2 = CrearDates(@Html.Raw(Model.LiniaGeneral.LlistaAlimentacio[2].EstatsJson));

    if (estatsInfeed || estatsInfeed2) {
        var minimumDate = moment("@Html.Raw(Model.LiniaGeneral.DataMinima).ToString()", "YYYY/MM/DD HH:mm:ss");
        var maximumDate = moment("@Html.Raw(Model.LiniaGeneral.DataMaxima).ToString()", "YYYY/MM/DD HH:mm:ss");

        var iniciData = moment("@Model.LiniaGeneral.Inici", "DD/MM/YYYY HH:mm:ss").format("YYYY/MM/DD HH:mm:ss");
        var finalData = moment("@Model.LiniaGeneral.Final", "DD/MM/YYYY HH:mm:ss").format("YYYY/MM/DD HH:mm:ss");

        var iniciDataAnterior = moment("@Html.Raw(Model.LiniaGeneral.IniciAnteriorStr).ToString()", "YYYY/MM/DD HH:mm:ss");
        var finalDataAnterior = moment("@Html.Raw(Model.LiniaGeneral.FinalAnteriorStr).ToString()", "YYYY/MM/DD HH:mm:ss");

        var percentatgeCaixes = @Html.Raw(Json.Encode(Model.LiniaGeneral.PercentatgesNoReads));

        if (percentatgeCaixes.length > 0) {
            donutchart("#DonutWarningPercentatgeCaixes", percentatgeCaixes, 30, "Nom");
        }
        else
            $('#containerPercentatgeCaixesTotals').hide();

        var percentatgeAlarmes = @Html.Raw(Json.Encode(Model.LiniaGeneral.PercentatgesAlarmes));

        if (percentatgeAlarmes.length > 0) {
            donutchart("#DonutAlarmes", percentatgeAlarmes, 30, "Nom");
        }
        else {
            $('#containerAlarmesFrequents').hide();
        }



        $('#containerAlarmes').hide();
        $('#TableAlarms').hide();

        $('#divPDF').show();
    }
    else {
        hideGraphics();
        //$('#noData').show();
        $('#containerPercentatgeEstats').hide();
        $('#containerRebuigTotal').hide();
        $('#TableAlarms').hide();
        $('#atras').hide();
        $('#containerAlarmes').hide();
        $('#containerAlarmesFrequents').hide();
        $('#containerPercentatgeCaixesTotals').hide();
    }
    $("#divLoading").hide();

    //Actualitzem la navbarSupportedContent per tal de dividir les gràfiques
    ActualitzarNavbar();

    function ActualitzarNavbar(){
        $('#navbarSupportedContent').find('a').remove();
       // $("#navbarSupportedContent").prepend("<a onclick='hideGraphics();' href='#' class='nav-item nav-link' style='margin-right:10px;'><i class='fa fa-bell pull-left' style='margin-top:2%;'></i>@Recursos.Idioma.LlistaAlarmes</a>");
       // $("#navbarSupportedContent").prepend("<a onclick='showGraphics();' href='#' class='nav-item nav-link' style='margin-right:10px'><i class='fa fa-bar-chart pull-left' style='margin-top:2%;'></i>@Recursos.Idioma.Grafiques</a>");
       // $("#navbarSupportedContent").prepend("<a onclick='showDades();' href='#' class='nav-item nav-link' style='margin-right:10px'><i class='fa fa-pencil pull-left' style='margin-top:2%;'></i>@Recursos.Idioma.Resum</a>");
        //$("#navbarSupportedContent").find('li').prepend("<a onclick='showVariables();' href='#' style='margin-right:10px'>@Recursos.Idioma.CanviVariables</a>");
    }

    function seedData() {//valors inicials de realtimeChart
        var endOfDate = (iniciData._i.split("/"))
        var endNow = new Date(endOfDate[1] + "/" + endOfDate[0] + "/" + endOfDate[2])

        for (var i = 0; i < MAX_LENGTH; ++i) {
            lineArr.push({
                time: new Date(endNow.getTime() - ((MAX_LENGTH - i) * duration)),
                z: 0
            });
        }
    }

    function CrearDates(jsonObj) {

        for (var i in jsonObj) {
            jsonObj[i].Inici = new Date(jsonObj[i].Inici);
            jsonObj[i].Final = new Date(jsonObj[i].Final);
        }
        return jsonObj;
    }

    function hideGraphics() {
        //$('#containerProducte').hide();
        $('#containerEstats').hide();
        $('#containerPercentatgeEstats').hide();
        $('#containerCadencia').hide();
        $('#containerCaixesTotals').hide();
        $('#containerCaixesTotalsL1').hide();
        $('#containerCaixesTotalsL2').hide();
        $('#divPDF').hide();
        $('#containerDades').hide();
        $('#TableVariables').hide();
        $('#tableContentVariables').hide();
        $('#divTotalCaixes').hide();
    }

    function showGraphics() {
        if (estatsJson.length > 0) { //Per mantenir l'estructura de la pàgina, altrament es farà més petita i es solapen els elements.
            $('#containerProducte').show();
            $('#containerEstats').show();
            $('#containerPercentatgeEstats').show();
            $('#containerCadencia').show();
            $('#containerCaixesTotals').show();
            $('#containerCaixesTotalsL1').show();
            $('#containerCaixesTotalsL2').show();
            $('#divPDF').show();
            $('#containerAlarmes').show();//alarmes!
            $('#containerAlarmesFrequents').show();
            $('#TableAlarms').show();
            $('#containerDades').hide();
            $('#atras').hide();
            $('#TableVariables').hide();
            $('#tableContentVariables').hide();
            showCheckboxes();
        }
    }
    function showDades() {
        if (estatsJson.length > 0) {
            hideGraphics();
            $('#containerAlarmes').hide();
            $('#containerAlarmesFrequents').hide();
            $('#TableAlarms').hide();
            $('#atras').hide();
            $('#TableVariables').hide();
            $('#tableContentVariables').hide();
            $('#containerDades').show();
        }
    }

    function showCheckboxes() {
        $('#GraficLinealCadenciaCheckbox').show();
        $('#GraficLinealProducteCheckbox').show();
        $('#GraficLinealProducteL1Checkbox').show();
        $('#GraficLinealProducteL2Checkbox').show();
    }

    function ShowHideLine(div_id, checkboxId) {
        if (document.body.contains(document.getElementById(div_id))) {
            if (document.getElementById(div_id).style.opacity == 1 && $("input[id^='" + checkboxId.substring(0, checkboxId.length - 1) + "']:checked").length > 1) {//Esta actiu, el desactivem
                d3.select("#" + div_id).style("opacity", 0);
                document.getElementById(checkboxId).checked = false;
            }
            else {
                d3.select("#" + div_id).style("opacity", 1);
                document.getElementById(checkboxId).checked = true;
            }
        }
    }

    function ShowHideBackground(div_id, checkboxId) {
        if (document.body.contains(document.getElementById(div_id))) {
            if (document.getElementById(div_id).style.opacity != 0 && $("input[id^='" + checkboxId.substring(0, checkboxId.length - 1) + "']:checked").length > 1) {//Esta actiu, el desactivem
                d3.selectAll("#" + div_id).style("opacity", 0);
                document.getElementById(checkboxId).checked = false;
            }
            else {
                d3.selectAll("#" + div_id).style("opacity", 0.1);
                document.getElementById(checkboxId).checked = true;
            }
        }
    }

    function increaseZoom() {
        if (estatsJson) {
            var oldDateStart = "@Html.Raw(Model.LiniaGeneral.Inici).ToString()";
            var oldDateEnd = "@Html.Raw(Model.LiniaGeneral.Final).ToString()";

            var dateEnd = oldDateEnd.split("/");
            var dateStart = oldDateStart.split("/");

            var milisecondsEnd = Date.parse(dateEnd[1] + "/" + dateEnd[0] + "/" + dateEnd[2]);
            var milisecondsStart = Date.parse(dateStart[1] + "/" + dateStart[0] + "/" + dateStart[2]);

            var newDateMilli = milisecondsStart + ((milisecondsEnd - milisecondsStart) / 10);
            var newDate = new Date(newDateMilli);
            var newDateSplit = newDate.toString().split(" ");

            var test = newDateSplit[2] + "/" + returnMonthNumber(newDateSplit[1]) + "/" + newDate.getFullYear() + " " + newDate.getHours() + ":" + newDate.getMinutes() + ":" + newDate.getSeconds();

            $("#divLoading").show();
            var antInitDate = document.getElementById("dataInicial").value;
            var antFinalDate = document.getElementById("dataFinal").value;
            var list = document.getElementById('shiftDropDownList');
            var selectedShift = list.options[list.selectedIndex].value;
            $("#partial").load("/LiniaGeneral/LiniaGeneralPartial", { inici: test, final: antFinalDate, torn: selectedShift, iniciAnt: antInitDate, finalAnt: antFinalDate, nomMaquina: machine , idMaquina: @Model.LiniaGeneral.IdMaquina });
        }
    }

    function previosZoom() {
        if (estatsJson) {
            $("#divLoading").show();
            var dataIniciAnterior = document.getElementById("dataInicial").value;
            var dataFinalAnterior = document.getElementById("dataFinal").value;
            var list = document.getElementById('shiftDropDownList');
            var selectedShift = list.options[list.selectedIndex].value;
            $("#partial").load("/LiniaGeneral/LiniaGeneralPartial", { inici: dataIniciAnterior, final: dataFinalAnterior, torn: selectedShift, iniciAnt: minimumDate._i, finalAnt: maximumDate._i, nomMaquina: machine, idMaquina: @Model.LiniaGeneral.IdMaquina });
        }
    }

    function returnMonthNumber(monthname) {
        var monthShortNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
            "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
        ];
        var month = monthShortNames.indexOf(monthname);
        return month ? month + 1 : 0;
    }

    function refreshDuration() {
        var newDataIn = new Date(moment("@Html.Raw(Model.LiniaGeneral.Inici).ToString()", "DD/MM/YYYY HH:mm:ss"));
        var newDataFi = new Date(moment("@Html.Raw(Model.LiniaGeneral.Final).ToString()", "DD/MM/YYYY HH:mm:ss"));
        var duration = convertMSGrafica(Math.abs(newDataFi.getTime() - newDataIn.getTime()));
        var newDuration = "@Html.Raw(Recursos.Idioma.Duracio)" + ": " + duration;
        $("#textDurada").text(newDuration);
        document.getElementById('dataInicial').value = "@Html.Raw(Model.LiniaGeneral.Inici.ToString())";
        document.getElementById('dataFinal').value = "@Html.Raw(Model.LiniaGeneral.Final.ToString())";
    }

    function PDFBackend() {
        window.location.href = "@Html.Raw(@Url.Action("GenerarPDF", "LiniaGeneral", new { nomMaquina=@Model.LiniaGeneral.Nom, inici=@Model.LiniaGeneral.Inici.ToString(), final=@Model.LiniaGeneral.Final.ToString(), torn=0, idMaquina= @Model.LiniaGeneral.IdMaquina }))";
    }

    function DescarregarVideo(datainici, index) {

        var llistaCameres = document.getElementById("camerasAlarmaId" + index);
        var camaraId = llistaCameres.options[llistaCameres.selectedIndex].text;


        var url = "@Html.Raw(@Url.Action("DescarregarVideo", "Axxon", new { inici="iniciParam", idCamera = "idCameraParam"}))";
        url = url.replace("iniciParam", datainici);
        url = url.replace("idCameraParam", camaraId);

        window.open(url,"_blank");

    }

    $("a").click(function () {
        if ($(this).hasClass("fa-minus-circle")) {
            $(this).removeClass("fa-minus-circle");
            $(this).addClass("fa-plus-circle");
        }
        else if($(this).hasClass("fa-plus-circle")) {
            $(this).removeClass("fa-plus-circle");
            $(this).addClass("fa-minus-circle");
        }
    });

    $('#GraficaLinealCadenciaStrapexModal').on('show.bs.modal', function (event) {
        if ($(this).hasClass("in")) return;
        var myVal = $(event.relatedTarget).data('val');
        var index = 0;
        var dadesPlot = [];

        CleanGraph('conjunt-cadencies','lineChartTitle');

        var dadesChart = @Html.Raw(Json.Encode(Model.LiniaGeneral.ChartCadencies.Charts2));
                dadesChart.forEach(chart => {

                    let xAxisDate = chart.XAxis.map(x => {
                        let momentObj = moment(x, 'DD/MM/YYYY HH:mm:ss');
                        return momentObj.toDate();
                    });

                    let tracePlot = {
                        x: xAxisDate,
                        y: chart.YAxis,
                        mode: 'lines+markers',
                        name: chart.Titol,
                        visible: myVal == index,
                        hovertemplate: "" +
                            "<b>@Recursos.Idioma.Hora:</b> %{x|%x %H:%M:%S}<br>" +
                            "<b>@Recursos.Idioma.Cadencia:</b> %{y}  @Recursos.Idioma.Caixa / @Recursos.Idioma.Hora<br>" +
                            "<extra></extra>"
                    }

                    if (myVal == index)
                        $('#lineChartTitle').html(chart.Titol);

                    index = index + 1;
                    dadesPlot.push(tracePlot);

                });

                var layoutPlot = {
                    showlegend: true,
                    height: 600,
                    width: 1080,
                    autosize: false,
                    plot_bgcolor: "#353c48",
                    paper_bgcolor: "#353c48",
                    xaxis: {
                        title: null,
                        showline: true,
                        showgrid: true,
                        gridcolor: 'grey'
                    },
                    yaxis: {
                        title: null,
                        showline: true,
                        showgrid: true,
                        gridcolor: 'grey'
                    },
                    font: {
                        color: '#ffffff'
                    }
                };

                var configPlot = { responsive: true }

                Plotly.newPlot('conjunt-cadencies', dadesPlot, layoutPlot, configPlot);

    });

    $('#GraficaLinealCadenciaAllStrapexModal').on('show.bs.modal', function (event) {
        if ($(this).hasClass("in")) return;
        var dadesPlot = [];

        CleanGraph('conjunt-cadencies-all-strapex', 'lineChartTitleAllStrapex');

        var dadesChart = @Html.Raw(Json.Encode(Model.LiniaGeneral.ChartCadencies.Charts2));
                dadesChart.forEach(chart => {

                    let xAxisDate = chart.XAxis.map(x => {
                        let momentObj = moment(x, 'DD/MM/YYYY HH:mm:ss');
                        return momentObj.toDate();
                    });

                    let tracePlot = {
                        x: xAxisDate,
                        y: chart.YAxis,
                        mode: 'lines+markers',
                        name: chart.Titol,
                        hovertemplate: "" +
                            "<b>@Recursos.Idioma.Hora:</b> %{x|%x %H:%M:%S}<br>" +
                            "<b>@Recursos.Idioma.Cadencia:</b> %{y}  @Recursos.Idioma.Caixa / @Recursos.Idioma.Hora<br>" +
                            "<extra></extra>"
                    }

                    dadesPlot.push(tracePlot);

                });

                var layoutPlot = {
                    showlegend: true,
                    height: 600,
                    width: 1080,
                    autosize: false,
                    hovermode: "x",
                    plot_bgcolor: "#353c48",
                    paper_bgcolor: "#353c48",
                    xaxis: {
                        title: null,
                        showline: true,
                        showgrid: true,
                        gridcolor: 'grey'
                    },
                    yaxis: {
                        title: null,
                        showline: true,
                        showgrid: true,
                        gridcolor: 'grey'
                    },
                    font: {
                        color: '#ffffff'
                    }
                };

                var configPlot = { responsive: true }

        Plotly.newPlot('conjunt-cadencies-all-strapex', dadesPlot, layoutPlot, configPlot);

    });

    $('#InfoEscanersModal').on('show.bs.modal', function (event) {
        if ($(this).hasClass("in")) return;
        var escaner = $(event.relatedTarget).data('val');

        var dadesChart = @Html.Raw(Model.ObtenirDadesEscaner());

        CleanGraph('conjunt-piechart', 'donutchartTitleModal');
        $('#tbodyPiechart').html('');

        var llistaFiltrada = dadesChart.filter(e => e.Nom.includes(escaner));

        var valuesNoReads = [];
        var labelsNoReads = [];
        var pulls = [];
        var tbody = document.getElementById("tbodyPiechart");

        llistaFiltrada.forEach(estat => {

            valuesNoReads.push(estat.QuantitatCaixes);
            labelsNoReads.push(estat.Nom);
            pulls.push(0);
            tbody.appendChild(CreateTableRow(estat.Nom, estat.Percentatge, estat.QuantitatCaixes));
        });

        if (valuesNoReads.length > 0) {

            var data = [{
                type: "pie",
                values: valuesNoReads,
                labels: labelsNoReads,
                pull: pulls,
                textinfo: "label+percent",
                insidetextorientation: "radial"
            }];

            var layout = {
                height: 700,
                width: 700,
                colorway: ['#00FF00', '#FF0000']
            }

            $('#donutchartTitleModal').html(escaner);
            tbody.appendChild(CreateTableRow(null, null, valuesNoReads.reduce((a, b) => a + b), '@Recursos.Idioma.CaixesTotals', true));

            Plotly.newPlot('conjunt-piechart', data, layout);
        }
    });

    function CleanGraph(graph,title) {
        var graphDiv = document.getElementById(graph);
        graphDiv.innerHTML = '';

        var nameDiv = document.getElementById(title);
        nameDiv.innerHTML = '';
    }

    function CreateTableRow(name, percentage, totalboxes, textTotalBoxes,total) {

        var tr = document.createElement('tr');
        var tdNom = document.createElement('td');
        var tdPercentatge = document.createElement('td');

        if (total) {
            tr.style.backgroundColor = "darkgray";
            tdNom.appendChild(document.createTextNode(textTotalBoxes));
            tdPercentatge.appendChild(document.createTextNode(totalboxes));
        }
        else {
            tdNom.appendChild(document.createTextNode(name));
            tdPercentatge.appendChild(document.createTextNode(percentage + " % (" + totalboxes + " )"));
        }

        tr.appendChild(tdNom);
        tr.appendChild(tdPercentatge);

        return tr;
    }

    function ExportCsv() {
        var data = Plotly.d3.csv.parse(Plotly.d3.select('.plotly').select('.js-data').text());
        var csvContent = "data:text/csv;charset=utf-8,";
        data.forEach(function (rowArray) {
            var row = rowArray.join(",");
            csvContent += row + "\r\n";
        });

        var encodedUri = encodeURI(csvContent);
        var link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "data.csv");
        document.body.appendChild(link); // Required for FF

        link.click();
    }


</script>
